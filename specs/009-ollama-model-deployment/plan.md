# Implementation Plan: Ollama Model Deployment

**Branch**: `009-ollama-model-deployment` | **Date**: 2025-12-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/009-ollama-model-deployment/spec.md`

## Summary

Fix the production "Ollama API error: Not Found" by adding automatic model pulling to the deployment script. The Ollama Docker container starts successfully but lacks required models (`nomic-embed-text`, `llama3.2`). Solution: Modify `scripts/deploy.sh` to pull models after Ollama container health check, and enhance the existing `/api/health` endpoint to verify model availability.

## Technical Context

**Language/Version**: TypeScript 5.7 / Node.js (Next.js 16), Bash
**Primary Dependencies**: Next.js, Ollama API, Docker/Docker Compose
**Storage**: PostgreSQL (existing), LanceDB (existing), Ollama models volume
**Testing**: Vitest (unit), Playwright (e2e)
**Target Platform**: Linux VPS (Docker), macOS (development)
**Project Type**: Web application (Next.js monolith)
**Performance Goals**: Model pull adds <60s to deployment when models exist; health check <2s
**Constraints**: Deployment must not fail if model pull fails (warn only)
**Scale/Scope**: Single VPS deployment, single Ollama container

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle           | Status  | Notes                                                                      |
| ------------------- | ------- | -------------------------------------------------------------------------- |
| Documentation-First | ✅ PASS | Spec complete with user stories, requirements, success criteria            |
| Test-First (TDD)    | ✅ PASS | Unit tests for health check enhancement will precede implementation        |
| Modularity          | ✅ PASS | US1 (deploy script), US2 (health endpoint), US3 (startup) are independent  |
| Simplicity (YAGNI)  | ✅ PASS | Minimal changes to existing files, no new abstractions                     |
| Observability       | ✅ PASS | Health endpoint provides service status, deployment logs model pull status |
| Commit Discipline   | ✅ PASS | Atomic commits per task following .claude/rules.md                         |

## Project Structure

### Documentation (this feature)

```text
specs/009-ollama-model-deployment/
├── plan.md              # This file
├── spec.md              # Feature specification
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# Modified files for this feature
scripts/
└── deploy.sh            # Add Ollama model pulling after container health check

app/api/health/
└── route.ts             # Enhance to verify Ollama models are available

lib/embeddings/
└── ollama.ts            # Constants for model names (existing, no changes needed)

lib/claude/
└── client.ts            # Constants for Ollama model (existing, no changes needed)

# Tests
tests/
├── unit/
│   └── api/health/
│       └── route.test.ts  # Unit tests for enhanced health check
└── integration/
    └── ollama-health.test.ts  # Integration test for Ollama model availability
```

**Structure Decision**: This is a minimal change to existing infrastructure. Only two files modified (`scripts/deploy.sh`, `app/api/health/route.ts`), plus new tests.

## Implementation Approach

### Phase 1: Deploy Script Enhancement (US1)

Modify `scripts/deploy.sh` to:

1. Wait for Ollama container to be ready (using `ollama list` command)
2. Pull required models (`nomic-embed-text`, `llama3.2`)
3. Continue deployment even if model pull fails (log warning)

Insert after PostgreSQL health check (line 63) and before pgcrypto extension (line 65).

### Phase 2: Health Check Enhancement (US2)

Enhance existing `/api/health/route.ts` to:

1. Check not just Ollama connectivity, but verify required models exist
2. Return model-specific status (which models are available)
3. Add Claude API key validation (without making billable requests)

### Phase 3: Startup Validation (US3 - Optional)

Low priority. Consider adding Next.js instrumentation hook to log service status at startup. This can be deferred to a future iteration.

## Key Implementation Details

### Ollama Model Pull in Deploy Script

```bash
# Wait for Ollama to be ready
OLLAMA_ATTEMPTS=0
OLLAMA_MAX=30
while [ $OLLAMA_ATTEMPTS -lt $OLLAMA_MAX ]; do
    OLLAMA_ATTEMPTS=$((OLLAMA_ATTEMPTS + 1))
    if docker exec memoryloop-ollama ollama list > /dev/null 2>&1; then
        echo "Ollama is ready."
        break
    fi
    echo "Waiting for Ollama... (${OLLAMA_ATTEMPTS}/${OLLAMA_MAX})"
    sleep 2
done

# Pull required models with 5-minute timeout (idempotent - skips if already present)
echo "Ensuring Ollama models are available..."
timeout 300 docker exec memoryloop-ollama ollama pull nomic-embed-text || echo "Warning: Failed to pull nomic-embed-text"
timeout 300 docker exec memoryloop-ollama ollama pull llama3.2 || echo "Warning: Failed to pull llama3.2"
echo "Ollama models ready."
```

### Health Check Model Verification

```typescript
// Check if required models are available
const ollamaUrl = process.env.OLLAMA_BASE_URL || 'http://localhost:11434'
const response = await fetch(`${ollamaUrl}/api/tags`)
const data = await response.json()
const models = data.models?.map((m: { name: string }) => m.name) || []

const requiredModels = ['nomic-embed-text', 'llama3.2']
const missingModels = requiredModels.filter(
  (m) => !models.some((name: string) => name.startsWith(m))
)

if (missingModels.length > 0) {
  checks.ollama = {
    status: 'unhealthy',
    message: `Missing models: ${missingModels.join(', ')}`,
    models,
  }
}
```

### Claude API Key Validation (FR-007)

```typescript
// Check Claude API key presence (without making billable requests)
const claudeApiKey = process.env.ANTHROPIC_API_KEY
if (claudeApiKey) {
  checks.claude = { status: 'healthy' }
} else {
  checks.claude = {
    status: 'degraded',
    message: 'ANTHROPIC_API_KEY not configured - Claude features unavailable',
  }
}
```

## Complexity Tracking

No complexity violations. This feature:

- Modifies only 2 existing files
- Adds minimal bash script logic
- Enhances existing health check (no new endpoint)
- No new abstractions or patterns introduced
