#!/bin/bash

# Pre-push hook for test validation and branch protection
# See specs/008-pre-commit-hooks for documentation
#
# Runs:
# 1. Unit tests (npm test -- --run)
#
# Note: Integration tests are run in CI, not pre-push, because they
# require external services (Ollama, PostgreSQL) that may not be available.
#
# Features:
# - Retry logic: retries failed tests once before blocking (FR-004a)
# - Flaky test warning: warns if tests pass on retry
# - Main branch protection: blocks direct pushes to main
#
# Bypass with: git push --no-verify

set -e

protected_branch="main"

# Function to run tests with retry logic
run_tests_with_retry() {
    local test_name="$1"
    local test_command="$2"

    echo "üß™ Running $test_name..."

    if eval "$test_command"; then
        echo "‚úÖ $test_name passed."
        return 0
    fi

    echo ""
    echo "‚ö†Ô∏è  $test_name failed. Retrying once..."
    echo ""

    if eval "$test_command"; then
        echo ""
        echo "‚ö†Ô∏è  $test_name passed on retry - potential flaky test detected!"
        echo "   Consider investigating test stability."
        echo ""
        return 0
    fi

    echo ""
    echo "‚ùå $test_name failed after retry."
    return 1
}

# Check branch protection
while read local_ref local_sha remote_ref remote_sha
do
  if [[ "$remote_ref" == *"$protected_branch"* ]]; then
    if [[ "$FORCE_PUSH_MAIN" != "1" ]]; then
      echo ""
      echo "üö´ Direct push to '$protected_branch' is blocked."
      echo ""
      echo "Please create a pull request instead:"
      echo "  git checkout -b feature/my-branch"
      echo "  git push -u origin feature/my-branch"
      echo "  gh pr create"
      echo ""
      echo "To bypass (admin only):"
      echo "  FORCE_PUSH_MAIN=1 git push"
      echo ""
      exit 1
    else
      echo "‚ö†Ô∏è  Bypassing branch protection (FORCE_PUSH_MAIN=1)"
    fi
  fi
done

echo ""
echo "üîç Running pre-push checks..."
echo ""

# Apply database migrations if DATABASE_URL is set
if [ -n "$DATABASE_URL" ]; then
    echo "üìä Applying database migrations..."

    # Push schema changes
    if ! npm run db:push > /dev/null 2>&1; then
        echo "‚ö†Ô∏è  Warning: db:push failed, continuing with tests..."
    fi

    # Apply manual migrations (idempotent)
    if command -v psql > /dev/null 2>&1; then
        # Extract database connection info from DATABASE_URL
        # Format: postgresql://user:pass@host:port/dbname
        DB_NAME=$(echo "$DATABASE_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')

        if [ -f "drizzle/0002_fix_review_logs_types.sql" ]; then
            psql "$DATABASE_URL" -f drizzle/0002_fix_review_logs_types.sql > /dev/null 2>&1 || true
        fi

        if [ -f "drizzle/0005_add_password_changed_at.sql" ]; then
            psql "$DATABASE_URL" -f drizzle/0005_add_password_changed_at.sql > /dev/null 2>&1 || true
        fi
    fi

    echo "‚úÖ Database migrations applied."
else
    echo "‚ö†Ô∏è  DATABASE_URL not set, skipping migrations (tests may fail)"
fi

echo ""

# Run unit tests with retry
if ! run_tests_with_retry "Unit tests" "npm test -- --run"; then
    echo ""
    echo "‚ùå Pre-push checks failed."
    echo ""
    echo "Please fix the failing tests before pushing."
    echo "To bypass (not recommended): git push --no-verify"
    exit 1
fi

# Note: Integration tests require external services and are run in CI instead

echo ""
echo "‚úÖ All pre-push checks passed."
exit 0
